<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barcode Scanner with Stock Management</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <style>
        #scanner-container {
            position: relative;
            width: 100%;
            max-width: 600px;
            margin: auto;
        }

        #scanner {
            width: 100%;
            height: auto;
            border: 1px solid #ccc;
        }

        #barcode-result {
            text-align: center;
            margin-top: 20px;
            font-size: 18px;
        }

        #controls {
            text-align: center;
            margin-top: 20px;
        }

        #controls button {
            padding: 10px 20px;
            margin: 10px;
            font-size: 16px;
            cursor: pointer;
        }

        #accepted-list {
            width: 100%;
            max-width: 600px;
            margin: 20px auto;
            border-collapse: collapse;
            border: 1px solid #ccc;
        }

        #accepted-list th, #accepted-list td {
            border: 1px solid #ccc;
            padding: 10px;
            text-align: center;
        }

        #accepted-list th {
            background-color: #f4f4f4;
        }

        h1 {
            text-align: center;
        }
    </style>
</head>
<body>

    <h1>Stock Management Barcode Scanner</h1>

    <div id="scanner-container">
        <div id="scanner"></div> <!-- Camera feed -->
    </div>

    <div id="barcode-result">
        <h3>Scanned Barcode: <span id="barcode-output">Waiting for scan...</span></h3>
    </div>

    <div id="controls">
        <button id="accept-btn" disabled>Accept</button>
        <button id="reject-btn" disabled>Reject</button>
        <button id="new-scan-btn">Start New Scan</button>
    </div>

    <table id="accepted-list">
        <thead>
            <tr>
                <th>Barcode</th>
                <th>Count</th>
            </tr>
        </thead>
        <tbody>
            <!-- Barcode list will be dynamically populated here -->
        </tbody>
    </table>

    <script>
        let currentBarcode = null;
        let acceptedBarcodes = {};

        document.addEventListener("DOMContentLoaded", function () {
            // Function to start the scanner
            function startScanner() {
                Quagga.init({
                    inputStream: {
                        name: "Live",
                        type: "LiveStream",
                        target: document.querySelector('#scanner'),
                        constraints: {
                            width: 640,
                            height: 480,
                            facingMode: "environment" // Back camera
                        }
                    },
                    decoder: {
                        readers: ["code_128_reader", "ean_reader", "ean_8_reader", "code_39_reader"]
                    }
                }, function (err) {
                    if (err) {
                        console.error(err);
                        return;
                    }
                    console.log("QuaggaJS initialized and starting...");
                    Quagga.start();
                });

                Quagga.onDetected(function (result) {
                    currentBarcode = result.codeResult.code;
                    document.getElementById('barcode-output').textContent = currentBarcode;

                    // Enable the Accept and Reject buttons
                    document.getElementById('accept-btn').disabled = false;
                    document.getElementById('reject-btn').disabled = false;

                    // Stop the scanner temporarily to prevent multiple detections
                    Quagga.stop();
                });
            }

            // Start scanning on page load
            startScanner();

            // Accept button logic
            document.getElementById('accept-btn').addEventListener('click', function () {
                if (currentBarcode) {
                    // If barcode is already accepted, increase its count
                    if (acceptedBarcodes[currentBarcode]) {
                        acceptedBarcodes[currentBarcode]++;
                    } else {
                        // Otherwise, add it to the list with count 1
                        acceptedBarcodes[currentBarcode] = 1;
                    }

                    // Update the list of accepted barcodes
                    updateAcceptedList();

                    // Clear current barcode
                    currentBarcode = null;
                    document.getElementById('barcode-output').textContent = "Waiting for scan...";
                    document.getElementById('accept-btn').disabled = true;
                    document.getElementById('reject-btn').disabled = true;
                }
            });

            // Reject button logic
            document.getElementById('reject-btn').addEventListener('click', function () {
                // Simply clear the current barcode without adding it to the list
                currentBarcode = null;
                document.getElementById('barcode-output').textContent = "Waiting for scan...";
                document.getElementById('accept-btn').disabled = true;
                document.getElementById('reject-btn').disabled = true;
            });

            // New scan button logic
            document.getElementById('new-scan-btn').addEventListener('click', function () {
                // Start a new scan
                startScanner();
            });

            // Function to update the accepted barcode list
            function updateAcceptedList() {
                const tbody = document.querySelector('#accepted-list tbody');
                tbody.innerHTML = ''; // Clear current list

                for (const barcode in acceptedBarcodes) {
                    const row = document.createElement('tr');
                    const barcodeCell = document.createElement('td');
                    const countCell = document.createElement('td');

                    barcodeCell.textContent = barcode;
                    countCell.textContent = acceptedBarcodes[barcode];

                    row.appendChild(barcodeCell);
                    row.appendChild(countCell);
                    tbody.appendChild(row);
                }
            }
        });
    </script>

</body>
</html>
